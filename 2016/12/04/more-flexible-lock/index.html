
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>更加灵活的Lock | 葛一凡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="葛一凡">
    

    
    <meta name="description" content="Lock是一把相对于更加灵活的锁。灵活之处在于提供了超时、可中断的获取锁方式，把这种自由度交给用户控制；与synchronized不同，Java内置锁就像一个大包大揽的家长，把获取、释放锁都自己处理了。依然保持上文中的观点：如果仅仅是为了实现互斥，而不需要使用基于Lock的附加属性（中断、条件等），推荐优先使用synchronized。">
<meta property="og:type" content="article">
<meta property="og:title" content="更加灵活的Lock">
<meta property="og:url" content="http://marvinsworld.github.io/2016/12/04/more-flexible-lock/index.html">
<meta property="og:site_name" content="葛一凡">
<meta property="og:description" content="Lock是一把相对于更加灵活的锁。灵活之处在于提供了超时、可中断的获取锁方式，把这种自由度交给用户控制；与synchronized不同，Java内置锁就像一个大包大揽的家长，把获取、释放锁都自己处理了。依然保持上文中的观点：如果仅仅是为了实现互斥，而不需要使用基于Lock的附加属性（中断、条件等），推荐优先使用synchronized。">
<meta property="og:image" content="http://marvinsworld.github.io/img/lock.png">
<meta property="og:image" content="http://marvinsworld.github.io/img/qrcode.jpg">
<meta property="og:updated_time" content="2017-03-10T05:46:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="更加灵活的Lock">
<meta name="twitter:description" content="Lock是一把相对于更加灵活的锁。灵活之处在于提供了超时、可中断的获取锁方式，把这种自由度交给用户控制；与synchronized不同，Java内置锁就像一个大包大揽的家长，把获取、释放锁都自己处理了。依然保持上文中的观点：如果仅仅是为了实现互斥，而不需要使用基于Lock的附加属性（中断、条件等），推荐优先使用synchronized。">
<meta name="twitter:image" content="http://marvinsworld.github.io/img/lock.png">

    
    <link rel="alternative" href="/atom.xml" title="葛一凡" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="葛一凡" title="葛一凡"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="葛一凡">葛一凡</a></h1>
				<h2 class="blog-motto">生命在于折腾，没有不安和躁动，就不会有梦……</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:marvinsworld.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/04/more-flexible-lock/" title="更加灵活的Lock" itemprop="url">更加灵活的Lock</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="葛一凡" target="_blank" itemprop="author">葛一凡</a>
		
  <p class="article-time">
    <time datetime="2016-12-04T14:50:32.000Z" itemprop="datePublished"> 发表于 2016-12-04</time>
    
  </p>
  <p class="article-hits" id="busuanzi_container_page_pv">阅读次数 <span id="busuanzi_value_page_pv"></span>
  </p>
</header>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#锁目的"><span class="toc-number">1.</span> <span class="toc-text">锁目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS原理"><span class="toc-number">2.</span> <span class="toc-text">CAS原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Acquire和Release"><span class="toc-number">3.</span> <span class="toc-text">Acquire和Release</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol>
		
		</div>
		
		<p><img src="/img/lock.png" width="300" class="img-topic"><br>Lock是一把相对于更加灵活的锁。灵活之处在于提供了超时、可中断的获取锁方式，把这种自由度交给用户控制；与synchronized不同，Java内置锁就像一个大包大揽的家长，把获取、释放锁都自己处理了。依然保持上文中的观点：如果仅仅是为了实现互斥，而不需要使用基于Lock的附加属性（中断、条件等），推荐优先使用synchronized。<br><a id="more"></a></p>
<h2 id="锁目的"><a href="#锁目的" class="headerlink" title="锁目的"></a>锁目的</h2><blockquote>
<p>A lock is a tool for controlling access to a shared resource by multiple threads. Commonly, a lock provides exclusive access to a shared resource: only one thread at a time can acquire the lock and all access to the shared resource requires that the lock be acquired first.</p>
</blockquote>
<p>锁是一种用于控制多个线程访问共享资源的工具。通常，锁提供了对共享资源的独占访问：同一时间只允许一个线程获取锁，在获取锁之后，才能访问共享资源（源自官方API文档）。锁的目的在于保护资源，为防止多个线程同时操作同一个资源，设计了Lock的方式，只有拿到Lock这个凭证，才有权操作资源。</p>
<p>Lock的设计本身就有乐观的含义。Lock的核心思路是：多个线程在同一时间访问同一资源的几率不大，在操作资源时一般不会出现争抢。因此首先尝试去获取锁，如果发现锁已经被占用，则使用自旋的方式重试（而不是使用休眠的方式等待锁的释放），直到获取锁。在资源争抢不严重的情况下，Lock效果更好，虽然会有CPU空转的情况，但是比休眠唤醒的成本要低很多。</p>
<h2 id="CAS原理"><a href="#CAS原理" class="headerlink" title="CAS原理"></a>CAS原理</h2><p>CAS是Compare and Swap，是CPU级别的指令，Lock是通过CAS这个原子指令获取锁标识和释放锁标识。CAS通过调用JNI代码实现，例如sun.misc.Unsafe类的compareAndSwapInt()方法的native实现，可以在OpenJDK的源代码hotspot\src\share\vm\prims\unsafe.cpp中找到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x))</div><div class="line">  UnsafeWrapper(<span class="string">"Unsafe_CompareAndSwapInt"</span>);</div><div class="line">  oop p = JNIHandles::resolve(obj);</div><div class="line">  jint* addr = (jint *) index_oop_from_field_offset_long(p, offset);</div><div class="line">  <span class="keyword">return</span> (jint)(Atomic::cmpxchg(x, addr, e)) == e;</div><div class="line">UNSAFE_END</div></pre></td></tr></table></figure>
<p>Atomic::cmpxchg的实现不同的操作系统有所不同，以linux x86为例，源码位置在hotspot/src/os_cpu/linux_x86/vm/atomic_linux_x86.inline.hpp<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">inline jint     Atomic::cmpxchg    (jint     exchange_value, volatile jint*     dest, jint     compare_value) &#123;</div><div class="line">  int mp = os::is_MP();</div><div class="line">  __asm__ volatile (LOCK_IF_MP(%4) "cmpxchgl %1,(%3)"</div><div class="line">                    : "=a" (exchange_value)</div><div class="line">                    : "r" (exchange_value), "a" (compare_value), "r" (dest), "r" (mp)</div><div class="line">                    : "cc", "memory");</div><div class="line">  return exchange_value;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于LOCK前缀在Intel® 64 and IA-32 Architectures Software Developer’s Manual中详细的说明：在8.1.4中，</p>
<blockquote>
<p>For the Intel486 and Pentium processors, the LOCK# signal is always asserted on the bus during a LOCK operation, even if the area of memory being locked is cached in the processor.<br>For the P6 and more recent processor families, if the area of memory being locked during a LOCK operation is cached in the processor that is performing the LOCK operation as write-back memory and is completely contained in a cache line, the processor may not assert the LOCK# signal on the bus. Instead, it will modify the memory loca- tion internally and allow it’s cache coherency mechanism to ensure that the operation is carried out atomically. This operation is called “cache locking.” The cache coherency mechanism automatically prevents two or more proces- sors that have cached the same area of memory from simultaneously modifying data in that area.</p>
</blockquote>
<ol>
<li>LOCKQ前缀会锁定总线（优化后为锁定缓冲行），使其他处理器无法读写该指令访问的区域，保证指令执行的原子性。</li>
<li>禁止该指令与之前和之后的读和写指令重排序。</li>
<li>把写缓冲区中的所有数据刷新到内存中。（2，3还未从手册中找到出处）</li>
</ol>
<h2 id="Acquire和Release"><a href="#Acquire和Release" class="headerlink" title="Acquire和Release"></a>Acquire和Release</h2><p>通过加锁和解锁构成一个临界区，不用担心并发的冲突，保证对临界区的串行访问。Acquire和Release是一个整体，不能割裂使用。Acquire语义保证所有内存的读写操作必须在Acquire之后执行；Release语义保证所有的内存的读写操作必须在Release之前执行。</p>
<p>码字辛苦，痛并快乐着；理解可能存在偏差，字字斟酌推敲；抵制抄袭，践行原创技术之路。如能帮助读者一二，实为荣幸，我是葛一凡。<br><img src="/img/qrcode.jpg" alt="微信公众号" title="微信公众号"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/Lock.html" target="_blank" rel="external">官方API文档</a></li>
<li><a href="http://ifeve.com/java-memory-model-5/" target="_blank" rel="external">深入理解Java内存模型（五）——锁</a></li>
<li><a href="http://hedengcheng.com/?p=803" target="_blank" rel="external">并发编程系列之一：锁的意义</a></li>
<li>Intel® 64 and IA-32 Architectures Software Developer’s Manual</li>
<li><a href="http://www.jianshu.com/p/59ddb7002b30" target="_blank" rel="external">java中锁的探究（4）——乐观锁和悲观锁</a></li>
<li><a href="http://brokendreams.iteye.com/blog/2250109" target="_blank" rel="external">Jdk1.6 JUC源码解析(1)-atomic-AtomicXXX</a></li>
<li><a href="https://www.zhihu.com/question/26588157" target="_blank" rel="external">acquire and release semantics in mutex的理解</a></li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java并发演进之路/">Java并发演进之路</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/显示锁/">显示锁</a><a href="/tags/中断/">中断</a><a href="/tags/灵活/">灵活</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://marvinsworld.github.io/2016/12/04/more-flexible-lock/" data-title="更加灵活的Lock | 葛一凡" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/12/14/btrace-manual/" title="Btrace入门">
  <strong>上一篇：</strong><br/>
  <span>
  Btrace入门</span>
</a>
</div>


<div class="next">
<a href="/2016/11/30/volatile-explain/"  title="volatile语义">
 <strong>下一篇：</strong><br/> 
 <span>volatile语义
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/12/04/more-flexible-lock/" data-title="更加灵活的Lock" data-url="http://marvinsworld.github.io/2016/12/04/more-flexible-lock/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#锁目的"><span class="toc-number">1.</span> <span class="toc-text">锁目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS原理"><span class="toc-number">2.</span> <span class="toc-text">CAS原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Acquire和Release"><span class="toc-number">3.</span> <span class="toc-text">Acquire和Release</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Begin-Python/" title="Begin Python">Begin Python<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java并发演进之路/" title="Java并发演进之路">Java并发演进之路<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper怎么玩/" title="ZooKeeper怎么玩">ZooKeeper怎么玩<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/分布式/" title="分布式">分布式<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/基础/" title="基础">基础<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/实战性能优化/" title="实战性能优化">实战性能优化<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源/" title="开源">开源<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/感悟/" title="感悟">感悟<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/锁/" title="锁">锁<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/分布式/" title="分布式">分布式<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/一致性/" title="一致性">一致性<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/资源/" title="资源">资源<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Btrace/" title="Btrace">Btrace<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/场景/" title="场景">场景<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/并发/" title="并发">并发<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/感悟/" title="感悟">感悟<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/同步/" title="同步">同步<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/主内存/" title="主内存">主内存<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/工作内存/" title="工作内存">工作内存<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/共享变量/" title="共享变量">共享变量<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/利器/" title="利器">利器<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/堆栈/" title="堆栈">堆栈<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/监视器/" title="监视器">监视器<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/幂等/" title="幂等">幂等<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/重复提交/" title="重复提交">重复提交<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/副作用/" title="副作用">副作用<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/root/" title="root">root<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/hehe198504@126.com/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m 葛一凡. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/https://github.com/marvinsworld" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/hehe198504@126.com" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/marvinsworld@126.com" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:marvinsworld@126.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="葛一凡">葛一凡</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"marvinsworld"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F4c7951aacef6f32166c95fb3637e5a74' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
